<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Authentication Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border: 1px solid #ddd;
            padding: 25px;
            margin: 20px 0;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .test-btn {
            background: #007bff;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin: 8px;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        .test-btn:hover {
            background: #0056b3;
        }
        .test-btn.success {
            background: #28a745;
        }
        .test-btn.danger {
            background: #dc3545;
        }
        .success { 
            background: #d4edda; 
            color: #155724; 
            border: 1px solid #c3e6cb;
        }
        .error { 
            background: #f8d7da; 
            color: #721c24; 
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .result {
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 13px;
        }
        input {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 14px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: bold;
            color: #333;
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        h2 {
            color: #444;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .auth-status {
            position: sticky;
            top: 20px;
            z-index: 100;
        }
    </style>
</head>
<body>
    <h1>üöÄ Dynamic Authentication & Community Test</h1>

    <div class="container auth-status">
        <h2>üîç Current Authentication Status</h2>
        <button class="test-btn" onclick="checkAuthStatus()">Check Auth Status</button>
        <button class="test-btn danger" onclick="clearAuth()">Clear Auth & Logout</button>
        <div id="auth-status" class="result info">Click "Check Auth Status" to see current login state</div>
    </div>

    <div class="container">
        <h2>üë§ User Registration (Students)</h2>
        <div class="form-row">
            <div class="form-group">
                <label>Username:</label>
                <input type="text" id="reg-username" placeholder="e.g., student123">
            </div>
            <div class="form-group">
                <label>Email:</label>
                <input type="email" id="reg-email" placeholder="student@example.com">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>Password:</label>
                <input type="password" id="reg-password" placeholder="minimum 6 characters">
            </div>
            <div class="form-group">
                <label>First Name:</label>
                <input type="text" id="reg-firstname" placeholder="John">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>Last Name:</label>
                <input type="text" id="reg-lastname" placeholder="Doe">
            </div>
            <div class="form-group">
                <label>Roll Number:</label>
                <input type="text" id="reg-rollno" placeholder="CS2024001">
            </div>
        </div>
        <button class="test-btn" onclick="registerUser()">Register User</button>
        <button class="test-btn" onclick="fillSampleUser()">Fill Sample Data</button>
        <div id="register-result" class="result"></div>
    </div>

    <div class="container">
        <h2>üè¢ Company Registration</h2>
        <div class="form-row">
            <div class="form-group">
                <label>Username:</label>
                <input type="text" id="comp-username" placeholder="techcorp">
            </div>
            <div class="form-group">
                <label>Email:</label>
                <input type="email" id="comp-email" placeholder="contact@techcorp.com">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>Password:</label>
                <input type="password" id="comp-password" placeholder="minimum 6 characters">
            </div>
            <div class="form-group">
                <label>Company Name:</label>
                <input type="text" id="comp-name" placeholder="TechCorp Solutions">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>Website:</label>
                <input type="text" id="comp-website" placeholder="https://techcorp.com">
            </div>
            <div class="form-group">
                <label>Contact Name:</label>
                <input type="text" id="comp-contact" placeholder="Jane Smith">
            </div>
        </div>
        <div class="form-group">
            <label>Contact Phone:</label>
            <input type="text" id="comp-phone" placeholder="+1-555-0123">
        </div>
        <button class="test-btn" onclick="registerCompany()">Register Company</button>
        <button class="test-btn" onclick="fillSampleCompany()">Fill Sample Data</button>
        <div id="company-register-result" class="result"></div>
    </div>

    <div class="container">
        <h2>üîê Login (Existing Users)</h2>
        <div class="form-row">
            <div class="form-group">
                <label>Username/Email:</label>
                <input type="text" id="login-username" placeholder="Enter username or email">
            </div>
            <div class="form-group">
                <label>Password:</label>
                <input type="password" id="login-password" placeholder="Enter password">
            </div>
        </div>
        <button class="test-btn" onclick="loginUser()">Login</button>
        <button class="test-btn" onclick="loginWithSample()">Login with Sample User</button>
        <div id="login-result" class="result"></div>
    </div>

    <div class="container">
        <h2>üèòÔ∏è Test Community Features</h2>
        <button class="test-btn" onclick="testPublicCommunities()">Get Public Communities</button>
        <button class="test-btn" onclick="testMyCommunities()">Get My Communities</button>
        <button class="test-btn" onclick="testJoinCommunity()">Join Community #1</button>
        <button class="test-btn" onclick="testLeaveCommunity()">Leave Community #1</button>
        <div id="community-result" class="result"></div>
    </div>

    <div class="container">
        <h2>üåê Quick Links</h2>
        <button class="test-btn" onclick="window.open('http://localhost:4201/login', '_blank')">Angular Login Page</button>
        <button class="test-btn" onclick="window.open('http://localhost:4201/signup', '_blank')">Angular Signup Page</button>
        <button class="test-btn" onclick="window.open('http://localhost:4201/communities', '_blank')">Angular Communities</button>
        <button class="test-btn" onclick="window.open('http://localhost:4201/company-login', '_blank')">Angular Company Login</button>
    </div>

    <script>
        const baseUrl = 'http://localhost:8081/api';

        function displayResult(elementId, data, type = 'success') {
            const element = document.getElementById(elementId);
            element.className = `result ${type}`;
            element.textContent = typeof data === 'object' ? JSON.stringify(data, null, 2) : data;
        }

        function getAuthHeaders() {
            const token = localStorage.getItem('access_token');
            if (!token) throw new Error('No token found. Please login first.');
            return {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            };
        }

        async function checkAuthStatus() {
            const token = localStorage.getItem('access_token');
            const userId = localStorage.getItem('user_id');
            const username = localStorage.getItem('username');
            const role = localStorage.getItem('user_role');
            
            if (token) {
                displayResult('auth-status', 
                    `‚úÖ LOGGED IN\n` +
                    `Username: ${username}\n` +
                    `User ID: ${userId}\n` +
                    `Role: ${role}\n` +
                    `Token: ${token.substring(0, 30)}...\n\n` +
                    `You can now use community features!`, 'success'
                );
                
                // Test if token is valid by calling a protected endpoint
                try {
                    const response = await fetch(`${baseUrl}/communities/my-communities`, {
                        headers: getAuthHeaders()
                    });
                    if (!response.ok) {
                        displayResult('auth-status', 
                            `‚ö†Ô∏è TOKEN INVALID\n` +
                            `Username: ${username} (from storage)\n` +
                            `The token exists but is invalid or expired.\n` +
                            `Please login again with valid credentials.`, 'error'
                        );
                    }
                } catch (error) {
                    displayResult('auth-status', 
                        `‚ö†Ô∏è TOKEN VALIDATION FAILED\n` +
                        `Error: ${error.message}\n` +
                        `Please login again.`, 'error'
                    );
                }
            } else {
                displayResult('auth-status', 
                    `‚ùå NOT LOGGED IN\n` +
                    `Please register a new account or login with existing credentials.\n\n` +
                    `Sample users available:\n` +
                    `- demo_student1 / password123\n` +
                    `- demo_student2 / password123\n` +
                    `- demo_student3 / password123`, 'error'
                );
            }
        }

        function fillSampleUser() {
            document.getElementById('reg-username').value = `user${Date.now().toString().slice(-4)}`;
            document.getElementById('reg-email').value = `user${Date.now().toString().slice(-4)}@example.com`;
            document.getElementById('reg-password').value = 'password123';
            document.getElementById('reg-firstname').value = 'John';
            document.getElementById('reg-lastname').value = 'Doe';
            document.getElementById('reg-rollno').value = `CS2024${Math.floor(Math.random() * 1000).toString().padStart(3, '0')}`;
        }

        function fillSampleCompany() {
            const companyId = Date.now().toString().slice(-4);
            document.getElementById('comp-username').value = `company${companyId}`;
            document.getElementById('comp-email').value = `contact${companyId}@techcorp.com`;
            document.getElementById('comp-password').value = 'password123';
            document.getElementById('comp-name').value = `TechCorp ${companyId}`;
            document.getElementById('comp-website').value = `https://techcorp${companyId}.com`;
            document.getElementById('comp-contact').value = 'Jane Smith';
            document.getElementById('comp-phone').value = '+1-555-0123';
        }

        function loginWithSample() {
            document.getElementById('login-username').value = 'demo_student1';
            document.getElementById('login-password').value = 'password123';
            loginUser();
        }

        async function registerUser() {
            try {
                const userData = {
                    username: document.getElementById('reg-username').value,
                    email: document.getElementById('reg-email').value,
                    password: document.getElementById('reg-password').value,
                    studentFirstName: document.getElementById('reg-firstname').value,
                    studentLastName: document.getElementById('reg-lastname').value,
                    studentRollNumber: document.getElementById('reg-rollno').value
                };

                if (!userData.username || !userData.email || !userData.password) {
                    throw new Error('Username, email, and password are required');
                }

                displayResult('register-result', 'Registering user...', 'info');

                const response = await fetch(`${baseUrl}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(userData)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Registration failed: ${errorData.message || response.statusText}`);
                }

                const result = await response.json();
                
                // Store auth info
                localStorage.setItem('access_token', result.token);
                localStorage.setItem('user_id', result.id);
                localStorage.setItem('user_role', result.role);
                localStorage.setItem('username', result.username);

                displayResult('register-result', 
                    `‚úÖ USER REGISTERED & LOGGED IN!\n` +
                    `ID: ${result.id}\n` +
                    `Username: ${result.username}\n` +
                    `Email: ${result.email}\n` +
                    `Role: ${result.role}\n` +
                    `Token: ${result.token.substring(0, 30)}...\n\n` +
                    `You can now use community features!`
                );

                // Clear form
                document.getElementById('reg-username').value = '';
                document.getElementById('reg-email').value = '';
                document.getElementById('reg-password').value = '';
                document.getElementById('reg-firstname').value = '';
                document.getElementById('reg-lastname').value = '';
                document.getElementById('reg-rollno').value = '';

                // Update auth status
                setTimeout(checkAuthStatus, 500);

            } catch (error) {
                displayResult('register-result', `‚ùå Registration Error:\n${error.message}`, 'error');
            }
        }

        async function registerCompany() {
            try {
                const companyData = {
                    username: document.getElementById('comp-username').value,
                    email: document.getElementById('comp-email').value,
                    password: document.getElementById('comp-password').value,
                    companyName: document.getElementById('comp-name').value,
                    companyWebsite: document.getElementById('comp-website').value,
                    companyContactName: document.getElementById('comp-contact').value,
                    companyContactPhone: document.getElementById('comp-phone').value
                };

                if (!companyData.username || !companyData.email || !companyData.password || !companyData.companyName) {
                    throw new Error('Username, email, password, and company name are required');
                }

                displayResult('company-register-result', 'Registering company...', 'info');

                const response = await fetch(`${baseUrl}/auth/company-signup`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(companyData)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Company registration failed: ${errorData.message || response.statusText}`);
                }

                const result = await response.json();
                
                // Store auth info
                localStorage.setItem('access_token', result.token);
                localStorage.setItem('user_id', result.id);
                localStorage.setItem('user_role', result.role);
                localStorage.setItem('username', result.username);

                displayResult('company-register-result', 
                    `‚úÖ COMPANY REGISTERED & LOGGED IN!\n` +
                    `ID: ${result.id}\n` +
                    `Username: ${result.username}\n` +
                    `Email: ${result.email}\n` +
                    `Role: ${result.role}\n` +
                    `Company: ${result.companyName}\n` +
                    `Token: ${result.token.substring(0, 30)}...\n\n` +
                    `Company community created automatically!`
                );

                // Clear form
                document.getElementById('comp-username').value = '';
                document.getElementById('comp-email').value = '';
                document.getElementById('comp-password').value = '';
                document.getElementById('comp-name').value = '';
                document.getElementById('comp-website').value = '';
                document.getElementById('comp-contact').value = '';
                document.getElementById('comp-phone').value = '';

                // Update auth status
                setTimeout(checkAuthStatus, 500);

            } catch (error) {
                displayResult('company-register-result', `‚ùå Company Registration Error:\n${error.message}`, 'error');
            }
        }

        async function loginUser() {
            try {
                const loginData = {
                    username: document.getElementById('login-username').value,
                    password: document.getElementById('login-password').value
                };

                if (!loginData.username || !loginData.password) {
                    throw new Error('Username and password are required');
                }

                displayResult('login-result', 'Logging in...', 'info');

                const response = await fetch(`${baseUrl}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(loginData)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Login failed: ${errorData.message || response.statusText}`);
                }

                const result = await response.json();
                
                // Store auth info
                localStorage.setItem('access_token', result.token);
                localStorage.setItem('user_id', result.id);
                localStorage.setItem('user_role', result.role);
                localStorage.setItem('username', result.username);

                displayResult('login-result', 
                    `‚úÖ LOGIN SUCCESSFUL!\n` +
                    `ID: ${result.id}\n` +
                    `Username: ${result.username}\n` +
                    `Email: ${result.email}\n` +
                    `Role: ${result.role}\n` +
                    `Token: ${result.token.substring(0, 30)}...\n\n` +
                    `You can now use community features!`
                );

                // Clear form
                document.getElementById('login-username').value = '';
                document.getElementById('login-password').value = '';

                // Update auth status
                setTimeout(checkAuthStatus, 500);

            } catch (error) {
                displayResult('login-result', `‚ùå Login Error:\n${error.message}`, 'error');
            }
        }

        async function testPublicCommunities() {
            try {
                displayResult('community-result', 'Fetching public communities...', 'info');

                const response = await fetch(`${baseUrl}/communities/public`, {
                    headers: getAuthHeaders()
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const communities = await response.json();
                displayResult('community-result', 
                    `‚úÖ PUBLIC COMMUNITIES FETCHED!\n` +
                    `Found ${communities.length} communities:\n\n` +
                    communities.map((c, i) => 
                        `${i+1}. ${c.name}\n` +
                        `   Company: ${c.companyName}\n` +
                        `   Members: ${c.memberCount}\n` +
                        `   Joined: ${c.isJoined ? 'YES' : 'NO'}\n` +
                        `   Description: ${c.description}\n`
                    ).join('\n')
                );

            } catch (error) {
                displayResult('community-result', `‚ùå Public Communities Error:\n${error.message}`, 'error');
            }
        }

        async function testMyCommunities() {
            try {
                displayResult('community-result', 'Fetching my communities...', 'info');

                const response = await fetch(`${baseUrl}/communities/my-communities`, {
                    headers: getAuthHeaders()
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const communities = await response.json();
                displayResult('community-result', 
                    `‚úÖ MY COMMUNITIES FETCHED!\n` +
                    `You are a member of ${communities.length} communities:\n\n` +
                    communities.map((c, i) => 
                        `${i+1}. ${c.name}\n` +
                        `   Company: ${c.companyName}\n` +
                        `   Role: ${c.membershipRole}\n` +
                        `   Members: ${c.memberCount}\n` +
                        `   Joined: ${c.joinedAt}\n`
                    ).join('\n')
                );

            } catch (error) {
                displayResult('community-result', `‚ùå My Communities Error:\n${error.message}`, 'error');
            }
        }

        async function testJoinCommunity() {
            try {
                displayResult('community-result', 'Joining community #1...', 'info');

                const response = await fetch(`${baseUrl}/communities/1/join`, {
                    method: 'POST',
                    headers: getAuthHeaders()
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const result = await response.json();
                displayResult('community-result', 
                    `‚úÖ SUCCESSFULLY JOINED COMMUNITY!\n` +
                    `Message: ${result.message}\n` +
                    `Community: ${result.communityName || 'Community #1'}\n\n` +
                    `You can now refresh public communities to see the updated join status.`
                );

            } catch (error) {
                displayResult('community-result', `‚ùå Join Community Error:\n${error.message}`, 'error');
            }
        }

        async function testLeaveCommunity() {
            try {
                displayResult('community-result', 'Leaving community #1...', 'info');

                const response = await fetch(`${baseUrl}/communities/1/leave`, {
                    method: 'POST',
                    headers: getAuthHeaders()
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const result = await response.json();
                displayResult('community-result', 
                    `‚úÖ SUCCESSFULLY LEFT COMMUNITY!\n` +
                    `Message: ${result.message}\n\n` +
                    `You can now refresh public communities to see the updated join status.`
                );

            } catch (error) {
                displayResult('community-result', `‚ùå Leave Community Error:\n${error.message}`, 'error');
            }
        }

        function clearAuth() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('user_id');
            localStorage.removeItem('user_role');
            localStorage.removeItem('username');
            displayResult('auth-status', '‚úÖ Authentication cleared! Please login again.', 'info');
        }

        // Check auth status on page load
        window.onload = function() {
            setTimeout(checkAuthStatus, 100);
        };
    </script>
</body>
</html>